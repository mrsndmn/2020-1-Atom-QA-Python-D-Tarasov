- scm:
    name: final-project

    scm:
      - git:
          url: git@github.com:mrsndmn/2020-1-Atom-QA-Python-D-Tarasov.git
          credentials-id: 2529bc9c-a439-467d-8db0-3356ec6ef8f5
          basedir: src/qapython-tarasov
          branches:
            - origin/project

- job:
    name: final-project
    description: 'Final project job'
    project-type: freestyle

    scm:
      - final-project

    wrappers:
      - timestamps
      - workspace-cleanup
      - credentials-binding:
        - text:
            credential-id: 818c8244-9ace-431f-80f6-266d98c03e4a
            variable: VK_API_TOKEN

    triggers:
      - pollscm:
          cron: "* * * * 5"

    builders:
      - shell: |
          mkdir $WORKSPACE/allure-results
          cd src/qapython-tarasov/project
          python3.8 -m venv venv
          . ./venv/bin/activate
          ./venv/bin/pip3.8 install -U setuptools
          ./venv/bin/pip3.8 install -r requirements.txt

          PYTHONPATH=vkapi ./venv/bin/python3.8 -m pytest vkapi/ --alluredir=$WORKSPACE/allure-results

    publishers:
      - allure:
          results-path:
            - path: allure-results
          report-build-policy: ALWAYS


- job:
    name: final-project-vkapi
    description: 'Final project vk api tests'
    project-type: freestyle

    scm:
      - final-project

    wrappers:
      - timestamps
      - workspace-cleanup
      - credentials-binding:
        - text:
            credential-id: 818c8244-9ace-431f-80f6-266d98c03e4a
            variable: VK_API_TOKEN

    triggers:
      - pollscm:
          cron: "* * * * /5"

    builders:
      - shell: |
          mkdir $WORKSPACE/allure-results
          cd src/qapython-tarasov/project
          rm -rf venv
          python3.8 -m venv venv
          . ./venv/bin/activate
          ./venv/bin/pip3.8 install -U setuptools
          ./venv/bin/pip3.8 install -r requirements.txt

          PYTHONPATH=vkapi ./venv/bin/python -m pytest vkapi/ --alluredir=$WORKSPACE/allure-results

    publishers:
      - allure:
          results-path:
            - path: allure-results
          report-build-policy: ALWAYS